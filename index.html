<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å­—è©åœ°é¼ æˆ°</title>
<!-- å¼•å…¥ Tailwind CSS æ–¹ä¾¿å¿«é€Ÿç¾åŒ–ä»‹é¢ -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Tone.js ç”¨æ–¼ç”ŸæˆéŸ³æ•ˆ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
<!-- æ–°å¢ï¼šå¼•å…¥ SheetJS ç”¨æ–¼è™•ç† Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* è‡ªè¨‚å­—é«”èˆ‡åŸºæœ¬æ¨£å¼ */
body {
    font-family: 'KaiTi', 'BiauKai', 'DFKai-sb', 'æ¨™æ¥·é«”', sans-serif;
    background-color: #87CEEB; /* å¤©è—è‰²èƒŒæ™¯ */
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10+ */
    user-select: none; /* Standard syntax */
    overflow: hidden;
    position: relative;
}
/* æ–°å¢ï¼šå¯æ„›çš„èƒŒæ™¯å…ƒç´  */
body::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80px;
    height: 40px;
    background: #fff;
    border-radius: 50px;
    opacity: 0.9;
    box-shadow: 20px 8px 0 0 #fff, 180px 40px 0 5px #fff, 220px 30px 0 0 #fff, 300px 50px 0 3px #fff, -80px 80px 0 0 #fff;
    animation: clouds 80s linear infinite;
    z-index: -1;
}
@keyframes clouds {
    from { transform: translateX(-150%); }
    to { transform: translateX(150%); }
}
body::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100px;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80"><path d="M0 80 H 80 V 40 C 60 40, 60 60, 40 60 C 20 60, 20 40, 0 40 Z" fill="%234CAF50"/></svg>');
    background-size: 80px 80px;
    background-repeat: repeat-x;
    z-index: -1;
}

/* éŠæˆ²å®¹å™¨ï¼Œç¢ºä¿ç½®ä¸­ */
.game-container {
    width: 100%;
    max-width: 500px;
    margin: auto;
    padding: 1rem;
    position: relative;
    z-index: 1;
}
/* åœ°æ´çš„æ¨£å¼ */
.hole {
    width: 100px;
    height: 100px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 50"><path d="M0 50 C 20 20, 80 20, 100 50 Z" fill="%23A0522D" /><ellipse cx="50" cy="45" rx="48" ry="8" fill="%238B4513" /></svg>');
    background-size: 110% 100px;
    background-position: center bottom;
    background-repeat: no-repeat;
    position: relative;
    overflow: hidden; /* ä¿®æ”¹ï¼šå°‡ overflow è¨­ç‚º hiddenï¼Œè—ä½å‹•ç‰© */
}

/* å‹•ç‰©çš„å®¹å™¨æ¨£å¼ */
.animal-container {
    position: absolute;
    bottom: 5px; /* å†æ¬¡èª¿æ•´ä½ç½®ï¼Œè®“å‹•ç‰©æ›´æ·±å…¥æ´å£ */
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    transition: transform 0.2s ease-out;
    width: 90px;
    height: 90px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    z-index: 5;
}
/* å‹•ç‰©å†’å‡ºä¾†çš„ç‹€æ…‹ */
.animal-container.up {
    transform: translateX(-50%) translateY(0);
}
/* å‹•ç‰©SVGæ¨£å¼ */
.animal-svg {
    position: absolute;
    width: 100%;
    height: 100%;
    transition: transform 0.2s ease-in;
}
/* å‹•ç‰©ä¸Šçš„æ–‡å­— */
.character {
    position: relative;
    font-size: 44px; /* åŠ å¤§å­—é«” */
    color: #331C00; /* åŠ æ·±é¡è‰²ä»¥å¢åŠ å°æ¯”åº¦ */
    text-shadow: 0px 0px 5px rgba(255,255,255,0.8); /* æ–°å¢æ–‡å­—å¤–é™°å½±ï¼Œæ›´æ¸…æ™° */
    background-color: rgba(255, 248, 225, 0.85); /* èª¿æ•´èƒŒæ™¯è‰² */
    border-radius: 50%;
    width: 60px; /* åŠ å¤§åœ“åœˆ */
    height: 60px; /* åŠ å¤§åœ“åœˆ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    margin-bottom: 10px; /* ç¸®çŸ­èˆ‡å‹•ç‰©é ­çš„è·é›¢ */
    z-index: 10;
    transform: scale(0);
    transition: transform 0.2s ease-out;
    border: 2px solid rgba(255, 255, 255, 0.9); /* æ–°å¢é‚Šæ¡† */
}
.animal-container.up .character {
    transform: scale(1);
    transition-delay: 0.05s;
}

/* æ•²æ“Šå‹•ç•« */
.whacked .animal-svg {
    transform: rotate(20deg) scale(0.9);
    opacity: 0;
}
.whacked::after {
    content: 'â­ï¸';
    position: absolute;
    top: 10px;
    font-size: 30px;
    animation: bonk 0.3s ease-out forwards;
}
@keyframes bonk {
    0% { transform: scale(0.5); opacity: 1; }
    100% { transform: scale(1.5); opacity: 0; }
}

/* éŒ˜å­å‹•ç•« */
.hammer {
    position: absolute;
    top: -40px;
    left: 30px;
    width: 80px;
    height: 80px;
    pointer-events: none;
    z-index: 50;
    animation: hammer-swing 0.4s ease-out forwards;
}
@keyframes hammer-swing {
    0% { transform: rotate(60deg) scale(0.8); opacity: 0; }
    30% { transform: rotate(30deg) scale(1); opacity: 1; }
    60% { transform: rotate(-30deg) translate(20px, 40px); }
    100% { transform: rotate(-30deg) translate(20px, 40px); opacity: 0; }
}

/* åˆ†æ•¸è·³å‹•å‹•ç•« */
.score-pop {
    animation: pop 0.3s ease-out;
}
@keyframes pop {
    50% { transform: scale(1.3); }
}

/* åˆ†æ•¸å½ˆå‡ºå‹•ç•« */
.score-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    animation: floatUp 0.8s ease-out forwards;
    pointer-events: none;
}
@keyframes floatUp {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -150%) scale(1.2); opacity: 0; }
}
/* è¨­ç½®å½ˆçª—çš„é®ç½©å±¤ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
/* æŠ€èƒ½æŒ‰éˆ•æ¨£å¼ */
.skill-btn {
    background-color: #10B981;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    transition: all 0.2s;
    box-shadow: 0 4px #059669;
    border: none;
}
.skill-btn:disabled {
    background-color: #9CA3AF;
    color: #E5E7EB;
    cursor: not-allowed;
    box-shadow: 0 4px #6B7280;
}
.skill-btn:active:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 2px #059669;
}
/* è®€å–ä¸­çš„ spinner */
.loader {
    border: 4px solid #f3f3f3;
    border-radius: 50%;
    border-top: 4px solid #3498db;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* è‡ªå®šç¾©é¡Œåº«æ¨£å¼ */
#custom-library-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    padding: 0.5rem;
    text-align: left;
}
/* åœ°é¼ æ¢é ­å‹•ç•«æ¨£å¼ */
.mole-animation {
    position: absolute;
    width: 150px;
    height: 150px;
    pointer-events: none;
    z-index: 0;
    opacity: 0.8;
    mix-blend-mode: multiply;
}

.mole-animation video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 20px;
}

#main-menu-view {
    position: relative;
}

#main-menu-view .mole-animation {
    top: -20px;
    right: -20px;
    transform: scale(0.8);
    animation: float 3s ease-in-out infinite;
}

#user-selection-view {
    position: relative;
}

#user-selection-view .mole-animation {
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%) scale(0.7);
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) scale(0.8); }
    50% { transform: translateY(-10px) scale(0.82); }
}

@media (max-width: 640px) {
    .mole-animation {
        width: 120px;
        height: 120px;
        opacity: 0.6;
    }
}
</style>
</head>
<body class="flex items-center justify-center min-h-screen">

<div class="game-container text-center">
<h1 class="text-4xl font-bold text-slate-700 mb-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">å­—è©åœ°é¼ æˆ°</h1>

<!-- éŠæˆ²ä¸»ç•«é¢ -->
<div id="game-screen" class="hidden relative">
<!-- é ‚éƒ¨æ§åˆ¶æ¬„ -->
<div class="flex justify-between items-center mb-2">
    <h2 id="game-mode-title" class="text-xl font-bold text-slate-700">éŠæˆ²ä¸­</h2>
    <button id="save-quit-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">é›¢é–‹éŠæˆ²</button>
</div>
<!-- éŠæˆ²è³‡è¨Šæ¬„ -->
<div class="flex justify-around items-center bg-sky-100 rounded-lg p-3 mb-4 shadow-md border-2 border-sky-300">
    <div><p class="text-lg text-slate-600">ç›®æ¨™å­—</p><p id="target-char" class="text-5xl font-bold text-sky-600">å¤ª</p></div>
    <div><p class="text-lg text-slate-600">åˆ†æ•¸</p><p id="score" class="text-3xl font-bold text-green-600">0</p></div>
    <div id="timer-display"><p class="text-lg text-slate-600">æ™‚é–“</p><p id="timer" class="text-3xl font-bold text-red-600">60</p></div>
    <div id="combo-display"><p class="text-lg text-slate-600">é€£æ“Š</p><p id="combo" class="text-3xl font-bold text-orange-500">0</p></div>
    <div id="hits-display"><p class="text-lg text-slate-600">å‘½ä¸­</p><p id="hits" class="text-3xl font-bold text-blue-600">0 / 3</p></div>
</div>

<!-- æŠ€èƒ½æ¬„ -->
<div id="skills-bar" class="flex justify-center space-x-4 mb-4">
    <button id="skill-slow" class="skill-btn" disabled>ğŸ¢ æ¸›é€Ÿ (<span id="skill-slow-tokens">0</span>)</button>
</div>

<!-- éŠæˆ²ä¹å®®æ ¼ -->
<div id="game-board" class="grid grid-cols-3 gap-4 md:gap-6 relative justify-items-center">
</div>
</div>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start-screen" class="p-6 bg-white rounded-xl shadow-lg relative">
    <button id="settings-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
    <div id="user-selection-view">
        <!-- æ·»åŠ åœ°é¼ å‹•ç•« -->
        <div class="mole-animation">
            <video autoplay loop muted playsinline>
                <source src="assets/å‹•ç•«æ•ˆæœ/åœ°é¼ æ¢é ­.mp4" type="video/mp4">
            </video>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">é¸æ“‡å­¸ç”Ÿ</h2>
        <select id="user-select" class="w-full p-2 border border-slate-300 rounded-md mb-3"></select>
        <div class="flex space-x-2">
            <input type="text" id="new-user-name" placeholder="è¼¸å…¥æ–°å­¸ç”Ÿå§“å" class="flex-grow p-2 border border-slate-300 rounded-md">
            <button id="add-user-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢</button>
        </div>
        <button id="confirm-user-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition">ç¢ºå®š</button>
    </div>
    <div id="main-menu-view" class="hidden">
        <!-- æ·»åŠ åœ°é¼ å‹•ç•« -->
        <div class="mole-animation">
            <video autoplay loop muted playsinline>
                <source src="assets/å‹•ç•«æ•ˆæœ/åœ°é¼ æ¢é ­.mp4" type="video/mp4">
            </video>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">ä¸»é¸å–®</h2>
        <p class="text-lg text-slate-600 mb-4">æ­¡è¿, <span id="current-user-name" class="font-bold"></span>!</p>
        <div class="flex flex-col space-y-3">
            <button id="practice-mode-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition">é—–é—œç·´ç¿’</button>
            <button id="timed-mode-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition">è¨ˆæ™‚æ¯”è³½</button>
        </div>
        <p class="text-slate-500 mt-4 text-lg">æœ€é«˜ç´€éŒ„ï¼š<span id="high-score-start" class="font-bold">0</span></p>
    </div>
</div>

<!-- é—œå¡é¸æ“‡ç•«é¢ -->
<div id="level-selection-screen" class="modal-overlay hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-lg text-center">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">é¸æ“‡é—œå¡ (å››å¹´ç´š)</h2>
        <div id="level-grid" class="grid grid-cols-4 md:grid-cols-6 gap-3 max-h-[60vh] overflow-y-auto p-2">
            <!-- é—œå¡æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <button id="close-level-selection-btn" class="mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-8 rounded-lg text-lg transition">è¿”å›</button>
    </div>
</div>

<!-- é—œå¡çµæŸ/æ™‰ç´šå½ˆçª— -->
<div id="level-end-screen" class="modal-overlay hidden">
    <div class="bg-white p-8 rounded-xl shadow-lg text-center w-11/12 max-w-sm">
        <h2 id="level-end-title" class="text-3xl font-bold text-slate-800 mb-4"></h2>
        <p id="level-end-score" class="text-xl text-slate-600 mb-6"></p>
        <div class="flex flex-col space-y-3">
            <button id="review-mistakes-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">éŒ¯å­—å›æ†¶</button>
            <button id="next-level-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">ä¸‹ä¸€é—œ</button>
            <button id="end-game-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">çµæŸéŠæˆ²</button>
        </div>
    </div>
</div>

<!-- éŒ¯å­—å›æ†¶å½ˆçª— -->
<div id="review-screen" class="modal-overlay hidden">
     <div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-md text-left overflow-y-auto max-h-[80vh]">
        <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">éŒ¯å­—å›æ†¶</h2>
        <div id="mistakes-list" class="space-y-3"></div>
        <button id="close-review-btn" class="w-full mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">é—œé–‰</button>
    </div>
</div>

<!-- éŠæˆ²çµæŸç•«é¢ -->
<div id="game-over-screen" class="modal-overlay hidden">
    <div class="bg-white p-8 rounded-xl shadow-lg text-center w-11/12 max-w-sm">
        <h2 class="text-3xl font-bold text-slate-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
        <p class="text-xl text-slate-600 mb-4">ä½ çš„æœ€çµ‚å¾—åˆ†æ˜¯ï¼š</p>
        <p id="final-score" class="text-6xl font-extrabold text-yellow-500 mb-6">0</p>
        <p id="new-high-score-msg" class="hidden text-green-500 font-bold text-lg mb-4">æ­å–œï¼åˆ·æ–°æœ€é«˜ç´€éŒ„ï¼</p>
        <div id="ai-feedback-container" class="my-4 p-3 bg-blue-50 rounded-lg border border-blue-200 text-blue-800">
            <p id="ai-feedback-text">AI å¤¥ä¼´æ­£åœ¨ç‚ºæ‚¨æº–å‚™é¼“å‹µçš„è©±...</p>
        </div>
        <p class="text-slate-600 mb-4">æœ€é«˜ç´€éŒ„ï¼š<span id="high-score-end">0</span></p>
        <div id="stars" class="flex justify-center text-5xl mb-6"></div>
        <button id="restart-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition">è¿”å›ä¸»é¸å–®</button>
    </div>
</div>

<!-- è¨­å®šå½ˆçª— -->
<div id="settings-screen" class="modal-overlay hidden">
<div class="bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-md text-center overflow-y-auto max-h-[90vh]">
<h2 class="text-2xl font-bold text-slate-800 mb-4">éŠæˆ²è¨­å®š</h2>
<div class="mb-4">
    <h3 class="text-lg font-semibold text-slate-700 mb-3">åŒ¯å…¥/åŒ¯å‡ºé¡Œåº«</h3>
    <div class="flex space-x-2">
        <button id="import-excel-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">å°å…¥é¡Œåº« (Excel)</button>
        <button id="export-excel-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">å°å‡ºé¡Œåº« (Excel)</button>
    </div>
    <input type="file" id="excel-upload-input" class="hidden" accept=".xlsx, .xls">
</div>
<hr class="my-4 border-slate-200">
<div class="mb-4">
    <h3 class="text-lg font-semibold text-slate-700 mb-3">è‡ªå®šç¾©é¡Œåº«</h3>
    <div id="custom-library-list"><p class="text-slate-400">å°šç„¡è‡ªå®šç¾©é¡Œç›®</p></div>
    <button id="play-library-btn" class="w-full mt-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition" disabled>é–‹å§‹é¡Œåº«æŒ‘æˆ°</button>
</div>
<hr class="my-4 border-slate-200">
<div class="mb-4">
<h3 class="text-lg font-semibold text-slate-700 mb-3">æ‰‹å‹•æ–°å¢é¡Œç›®</h3>
<textarea id="custom-levels-input" rows="3" class="w-full p-2 border border-slate-300 rounded-md text-left" placeholder="æ–°å¢é¡Œç›®åˆ°é¡Œåº«...&#10;æ—¥:ç›®,æ›°&#10;å…:å…”,é­š"></textarea>
<p id="custom-error-msg" class="text-red-500 text-sm mt-2 h-4"></p>
<button id="add-custom-btn" class="w-full mt-3 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-8 rounded-lg text-lg transition">æ–°å¢åˆ°é¡Œåº«</button>
</div>
<button id="close-settings-btn" class="mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-8 rounded-lg text-lg transition">é—œé–‰</button>
</div>
</div>


<script>
// ç«‹å³åŸ·è¡Œå‡½å¼ä»¥é¿å…å…¨åŸŸè®Šæ•¸æ±™æŸ“
(function() {
    // ç­‰å¾… DOM å®Œå…¨è¼‰å…¥
    window.onload = function() {
        // --- DOM å…ƒç´ ç²å– ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const levelEndScreen = document.getElementById('level-end-screen');
        const reviewScreen = document.getElementById('review-screen');
        const levelSelectionScreen = document.getElementById('level-selection-screen');

        const gameBoard = document.getElementById('game-board');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const restartBtn = document.getElementById('restart-btn');
        
        // é–‹å§‹ç•«é¢
        const userSelectionView = document.getElementById('user-selection-view');
        const mainMenuView = document.getElementById('main-menu-view');
        const userSelect = document.getElementById('user-select');
        const newUserInput = document.getElementById('new-user-name');
        const addUserBtn = document.getElementById('add-user-btn');
        const confirmUserBtn = document.getElementById('confirm-user-btn');
        const currentUserEl = document.getElementById('current-user-name');
        const practiceModeBtn = document.getElementById('practice-mode-btn');
        const timedModeBtn = document.getElementById('timed-mode-btn');
        const highScoreStartEl = document.getElementById('high-score-start');

        // éŠæˆ²ç•«é¢
        const gameModeTitleEl = document.getElementById('game-mode-title');
        const saveQuitBtn = document.getElementById('save-quit-btn');
        const targetCharEl = document.getElementById('target-char');
        const scoreEl = document.getElementById('score');
        const timerDisplay = document.getElementById('timer-display');
        const timerEl = document.getElementById('timer');
        const comboDisplay = document.getElementById('combo-display');
        const comboEl = document.getElementById('combo');
        const hitsDisplay = document.getElementById('hits-display');
        const hitsEl = document.getElementById('hits');
        const skillSlowBtn = document.getElementById('skill-slow');
        const skillSlowTokensEl = document.getElementById('skill-slow-tokens');

        // é—œå¡é¸æ“‡ç•«é¢
        const levelGrid = document.getElementById('level-grid');
        const closeLevelSelectionBtn = document.getElementById('close-level-selection-btn');

        // çµæŸèˆ‡å›é¡§ç•«é¢
        const levelEndTitle = document.getElementById('level-end-title');
        const levelEndScore = document.getElementById('level-end-score');
        const reviewMistakesBtn = document.getElementById('review-mistakes-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const mistakesListEl = document.getElementById('mistakes-list');
        const closeReviewBtn = document.getElementById('close-review-btn');
        const finalScoreEl = document.getElementById('final-score');
        const newHighScoreMsgEl = document.getElementById('new-high-score-msg');
        const highScoreEndEl = document.getElementById('high-score-end');
        const starsEl = document.getElementById('stars');
        const aiFeedbackText = document.getElementById('ai-feedback-text');
        
        // è¨­å®šç•«é¢
        const customLibraryList = document.getElementById('custom-library-list');
        const playLibraryBtn = document.getElementById('play-library-btn');
        const customLevelsInput = document.getElementById('custom-levels-input');
        const customErrorMsg = document.getElementById('custom-error-msg');
        const addCustomBtn = document.getElementById('add-custom-btn');
        const importExcelBtn = document.getElementById('import-excel-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const excelUploadInput = document.getElementById('excel-upload-input');

        let holes = [];

        // --- éŠæˆ²ç‹€æ…‹èˆ‡è¨­å®š ---
        let gameState = {};
        let currentUser = null;
        let gameData = {};
        let timerId = null, animalIntervalId = null;
        let allMistakesInGame = [];

        // --- å…§å»ºå››å¹´ç´šé—œå¡ ---
        const gradeFourLevels = [
            { target: 'æŠ„', distractors: ['æ²™', 'å¦™', 'ç´—'] }, { target: 'æ²™', distractors: ['æŠ„', 'å¦™', 'ç´—'] },
            { target: 'åˆ¸', distractors: ['å·', 'å€¦', 'æ²'] }, { target: 'å·', distractors: ['åˆ¸', 'å€¦', 'æ²'] },
            { target: 'æ± ', distractors: ['æ–½', 'å¼›', 'é¦³'] }, { target: 'æ–½', distractors: ['æ± ', 'å¼›', 'é¦³'] },
            { target: 'å¥„', distractors: ['æ©', 'æ·¹', 'åºµ'] }, { target: 'æ©', distractors: ['å¥„', 'æ·¹', 'åºµ'] },
            { target: 'å»·', distractors: ['å»¶', 'èª•', 'èœ’'] }, { target: 'å»¶', distractors: ['å»·', 'èª•', 'èœ’'] },
            { target: 'æ»”', distractors: ['ç¨»', 'è¹ˆ', 'ç„°'] }, { target: 'ç¨»', distractors: ['æ»”', 'è¹ˆ', 'ç„°'] },
            { target: 'é ’', distractors: ['é Œ', 'é ˜', 'é '] }, { target: 'é Œ', distractors: ['é ’', 'é ˜', 'é '] },
            { target: 'æ„‰', distractors: ['å·', 'å–»', 'è¼¸'] }, { target: 'å·', distractors: ['æ„‰', 'å–»', 'è¼¸'] },
            { target: 'ç›¸', distractors: ['ç®±', 'å»‚', 'éœœ'] }, { target: 'ç®±', distractors: ['ç›¸', 'å»‚', 'éœœ'] },
            { target: 'æ–', distractors: ['é™', 'ç‘¤', 'è¬ '] }, { target: 'é™', distractors: ['æ–', 'ç‘¤', 'è¬ '] },
            { target: 'æ²¹', distractors: ['æŠ½', 'è¿ª', 'è¢–'] }, { target: 'æŠ½', distractors: ['æ²¹', 'è¿ª', 'è¢–'] },
            { target: 'å¢', distractors: ['è´ˆ', 'æ†', 'åƒ§'] }, { target: 'è´ˆ', distractors: ['å¢', 'æ†', 'åƒ§'] },
            { target: 'ä½œ', distractors: ['æ˜¨', 'è©', 'ä¹'] }, { target: 'æ˜¨', distractors: ['ä½œ', 'è©', 'ä¹'] },
            { target: 'è­˜', distractors: ['ç¹”', 'è·', 'å¹Ÿ'] }, { target: 'ç¹”', distractors: ['è­˜', 'è·', 'å¹Ÿ'] },
            { target: 'å ', distractors: ['åº—', 'ä½”', 'æ²¾'] }, { target: 'åº—', distractors: ['å ', 'ä½”', 'æ²¾'] },
            { target: 'æŸ', distractors: ['è¬€', 'åª’', 'ç…¤'] }, { target: 'è¬€', distractors: ['æŸ', 'åª’', 'ç…¤'] },
            { target: 'å‰‡', distractors: ['æ¸¬', 'å´', 'æƒ»'] }, { target: 'æ¸¬', distractors: ['å‰‡', 'å´', 'æƒ»'] },
            { target: 'çŸ£', distractors: ['å”‰', 'åŸƒ', 'æŒ¨'] }, { target: 'å”‰', distractors: ['çŸ£', 'åŸƒ', 'æŒ¨'] },
            { target: 'å®¹', distractors: ['æº¶', 'ç†”', 'æ¦•'] }, { target: 'æº¶', distractors: ['å®¹', 'ç†”', 'æ¦•'] },
            { target: 'å®—', distractors: ['ç¶œ', 'æ·™', 'å´‡'] }, { target: 'ç¶œ', distractors: ['å®—', 'æ·™', 'å´‡'] },
            { target: 'ç´™', distractors: ['ä½', 'åº•', 'æŠµ'] }, { target: 'ä½', distractors: ['ç´™', 'åº•', 'æŠµ'] },
            { target: 'é‚£', distractors: ['å“ª', 'æŒª', 'å¨œ'] }, { target: 'å“ª', distractors: ['é‚£', 'æŒª', 'å¨œ'] },
            { target: 'æ·‘', distractors: ['æ¤’', 'å¯‚', 'ç£'] }, { target: 'æ¤’', distractors: ['æ·‘', 'å¯‚', 'ç£'] },
            { target: 'å®˜', distractors: ['å®®', 'ç‡Ÿ', 'ä¾¶'] }, { target: 'å®®', distractors: ['å®˜', 'ç‡Ÿ', 'ä¾¶'] },
            { target: 'èª', distractors: ['æ¢§', 'æ‚Ÿ', 'æ‚'] }, { target: 'æ¢§', distractors: ['èª', 'æ‚Ÿ', 'æ‚'] },
            { target: 'å¥´', distractors: ['åŠª', 'æ€’', 'æ•'] }, { target: 'åŠª', distractors: ['å¥´', 'æ€’', 'æ•'] },
            { target: 'æ­¡', distractors: ['å‹¸', 'è§€', 'çŒ'] }, { target: 'å‹¸', distractors: ['æ­¡', 'è§€', 'çŒ'] },
            { target: 'æ¨', distractors: ['å †', 'ç¨š', 'æƒŸ'] }, { target: 'å †', distractors: ['æ¨', 'ç¨š', 'æƒŸ'] },
            { target: 'å±ˆ', distractors: ['æ˜', 'å€”', 'å´›'] }, { target: 'æ˜', distractors: ['å±ˆ', 'å€”', 'å´›'] },
            { target: 'æ´', distractors: ['ç·©', 'æš–', 'åª›'] }, { target: 'ç·©', distractors: ['æ´', 'æš–', 'åª›'] },
            { target: 'å¹»', distractors: ['å¹¼', 'æ‹—', 'å³'] }, { target: 'å¹¼', distractors: ['å¹»', 'æ‹—', 'å³'] },
            { target: 'è´Š', distractors: ['è®š', 'é‘½', 'æ”¢'] }, { target: 'è®š', distractors: ['è´Š', 'é‘½', 'æ”¢'] },
            { target: 'ç« ', distractors: ['éšœ', 'å½°', 'èŸ‘'] }, { target: 'éšœ', distractors: ['ç« ', 'å½°', 'èŸ‘'] },
            { target: 'ç ', distractors: ['æ ª', 'æ®Š', 'è››'] }, { target: 'æ ª', distractors: ['ç ', 'æ®Š', 'è››'] },
            { target: 'æ–¬', distractors: ['æ¼¸', 'å¶„', 'æš«'] }, { target: 'æ¼¸', distractors: ['æ–¬', 'å¶„', 'æš«'] },
            { target: 'ä¾›', distractors: ['å“„', 'æ´ª', 'æ‹±'] }, { target: 'å“„', distractors: ['ä¾›', 'æ´ª', 'æ‹±'] }
        ];
        
        const animalSVGs = {
            mole: `<svg class="animal-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 95 C 80 100, 85 70, 85 50 C 85 20, 75 5, 50 5 C 25 5, 15 20, 15 50 C 15 70, 20 100, 50 95 Z" fill="#8D6E63"/><circle cx="35" cy="45" r="5" fill="black"/><circle cx="65" cy="45" r="5" fill="black"/><path d="M45 60 Q 50 70, 55 60" stroke="black" fill="none" stroke-width="3" stroke-linecap="round"/><ellipse cx="50" cy="30" rx="15" ry="8" fill="#FBC02D"/></svg>`,
            rabbit: `<svg class="animal-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M 50,90 C 75,95 80,70 80,50 C 80,25 70,10 50,10 C 30,10 20,25 20,50 C 20,70 25,95 50,90 Z" fill="white" stroke="#E0E0E0" stroke-width="2" /><path d="M 35,15 C 30,0 45,0 40,15 C 40,30 35,30 35,15 Z" fill="white" stroke="#E0E0E0" stroke-width="2" transform="rotate(-15 37 15)"/><path d="M 65,15 C 70,0 55,0 60,15 C 60,30 65,30 65,15 Z" fill="white" stroke="#E0E0E0" stroke-width="2" transform="rotate(15 63 15)"/><circle cx="40" cy="50" r="4" fill="black"/><circle cx="60" cy="50" r="4" fill="black"/><path d="M 48 60 L 52 60 M 50 60 L 50 65" stroke="#FF8A80" stroke-width="2" stroke-linecap="round"/></svg>`,
            cat: `<svg class="animal-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M20 90 C 10 70, 10 30, 30 20 L 50 10 L 70 20 C 90 30, 90 70, 80 90 Z" fill="#FFC107" /><path d="M30 20 L 20 5 L 40 15 Z" fill="#FF9800" /><path d="M70 20 L 80 5 L 60 15 Z" fill="#FF9800"/><circle cx="38" cy="55" r="5" fill="black"/><circle cx="62" cy="55" r="5" fill="black"/><path d="M45 65 Q 50 75, 55 65" stroke="black" fill="none" stroke-width="2" stroke-linecap="round"/></svg>`,
            bear: `<svg class="animal-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="55" r="35" fill="#A1887F"/><circle cx="30" cy="25" r="12" fill="#A1887F"/><circle cx="70" cy="25" r="12" fill="#A1887F"/><circle cx="30" cy="25" r="8" fill="#D7CCC8"/><circle cx="70" cy="25" r="8" fill="#D7CCC8"/><circle cx="50" cy="60" r="15" fill="#D7CCC8"/><circle cx="38" cy="50" r="4" fill="black"/><circle cx="62" cy="50" r="4" fill="black"/><path d="M50 65 C 45 72, 55 72, 50 65 Z" fill="black"/></svg>`
        };

        // éŸ³æ•ˆ
        let correctSound, incorrectSound, levelUpSound;
        try {
            correctSound = new Tone.Synth().toDestination();
            incorrectSound = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
            levelUpSound = new Tone.Synth({ oscillator: { type: 'sawtooth' } }).toDestination();
        } catch(e) { console.warn("Tone.js åˆå§‹åŒ–å¤±æ•—ï¼ŒéŸ³æ•ˆå°‡è¢«ç¦ç”¨ã€‚") }
        
        // ç²å‹éŸ³æ•ˆ
        const winnerSound = new Audio('assets/winner-game-sound-404167.mp3');
        winnerSound.volume = 0.7; // è¨­ç½®éŸ³é‡ç‚º 70%
        
        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---
        
        function createBoard() {
            gameBoard.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.classList.add('hole');
                const animalContainer = document.createElement('div');
                animalContainer.classList.add('animal-container');
                animalContainer.innerHTML = `
                    <div class="animal-svg-wrapper"></div>
                    <div class="character"></div>
                `;
                hole.appendChild(animalContainer);
                gameBoard.appendChild(hole);
                animalContainer.addEventListener('click', handleWhack);
            }
        }

        function startGame(mode, levels, startIndex = 0) {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            allMistakesInGame = [];

            let gameLevels = levels;
            // In timed mode, we shuffle for replayability.
            if (mode === 'timed') {
                gameLevels = [...levels].sort(() => Math.random() - 0.5);
            }

            // Restore skills if continuing, otherwise start fresh
            const initialSkills = (gameData.users[currentUser].skillTokens) 
                                ? gameData.users[currentUser].skillTokens 
                                : 0;
            
            gameState = {
                mode: mode,
                levelList: gameLevels,
                currentLevelIndex: startIndex,
                score: 0,
                combo: 0,
                timeLeft: 60,
                slowSkillTokens: initialSkills,
                correctHitsThisLevel: 0,
                mistakesThisLevel: [],
                gameSpeed: 1200, // å›ºå®šé€Ÿåº¦
                peepDuration: 1800, // å›ºå®šé€Ÿåº¦
            };

            // æ ¹æ“šæ¨¡å¼èª¿æ•´UI
            if (mode === 'practice') {
                timerDisplay.classList.add('hidden');
                hitsDisplay.classList.remove('hidden');
                comboDisplay.classList.add('hidden');
                saveQuitBtn.textContent = 'é›¢é–‹éŠæˆ²';
            } else { // timed
                timerDisplay.classList.remove('hidden');
                hitsDisplay.classList.add('hidden');
                comboDisplay.classList.remove('hidden');
                gameModeTitleEl.textContent = 'è¨ˆæ™‚æ¯”è³½ (å››å¹´ç´š)';
                saveQuitBtn.textContent = 'å„²å­˜ä¸¦é›¢é–‹';
                timerId = setInterval(updateTimer, 1000);
            }
            
            setupLevel();
        }

        function setupLevel() {
            if (gameState.currentLevelIndex >= gameState.levelList.length) {
                if (gameState.mode === 'timed') {
                    // In timed mode, just loop back
                    gameState.currentLevelIndex = 0;
                } else {
                    // In practice mode, end game
                    endGame(false);
                    return;
                }
            }
            gameState.correctHitsThisLevel = 0;
            gameState.mistakesThisLevel = [];
            
            updateUI();

            clearInterval(animalIntervalId);
            animalIntervalId = setInterval(peep, gameState.gameSpeed);
        }

        function updateTimer() {
            gameState.timeLeft--;
            if (gameState.timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                showLevelEndScreen(true); // æ™‚é–“åˆ°ï¼Œå¼·åˆ¶çµæŸ
            }
            updateUI();
        }

        function handleWhack(e) {
            const animalContainer = e.currentTarget;
            if (correctSound && Tone.context.state !== 'running') Tone.context.resume();
            if (!animalContainer.classList.contains('up')) return;
            
            animalContainer.classList.remove('up');
            animalContainer.classList.add('whacked');
            
            const currentLevel = gameState.levelList[gameState.currentLevelIndex];
            if (animalContainer.dataset.char === currentLevel.target) {
                gameState.combo++;
                const points = 10 + Math.min(gameState.combo, 10);
                gameState.score += points;
                gameState.correctHitsThisLevel++;
                if (correctSound) correctSound.triggerAttackRelease('C5', '8n');
                showScorePopup(`+${points}`, animalContainer, 'text-green-500');
                showHammerAnimation(animalContainer);
                
                if (gameState.mode === 'practice' && gameState.correctHitsThisLevel >= 3) {
                    showLevelEndScreen(false); // æ™‰ç´š
                } else if (gameState.mode === 'timed') {
                    // Reward skill on combo
                    if (gameState.combo > 0 && gameState.combo % 5 === 0) {
                        gameState.slowSkillTokens++;
                    }
                    switchToNextTarget();
                }

            } else {
                gameState.combo = 0;
                gameState.score = Math.max(0, gameState.score - 5);
                const mistake = {
                    target: currentLevel.target,
                    wrong: animalContainer.dataset.char
                };
                gameState.mistakesThisLevel.push(mistake);
                allMistakesInGame.push(mistake);

                if (incorrectSound) incorrectSound.triggerAttackRelease('A2', '8n');
                showScorePopup('-5', animalContainer, 'text-red-500');
            }
            updateUI();
        }

        function switchToNextTarget() {
            gameState.currentLevelIndex++;
            if (gameState.currentLevelIndex >= gameState.levelList.length) {
                // Reshuffle and start from the beginning if we went through all characters
                gameState.levelList = [...gradeFourLevels].sort(() => Math.random() - 0.5);
                gameState.currentLevelIndex = 0;
            }
            // Manually call setupLevel to update target character and UI immediately
            setupLevel();
        }
        
        function peep() {
            if (!holes || holes.length === 0) return;
            const hole = holes[Math.floor(Math.random() * holes.length)];
            const animalContainer = hole.querySelector('.animal-container');
            const characterEl = animalContainer.querySelector('.character');
            const animalSVGEl = animalContainer.querySelector('.animal-svg-wrapper');
            
            const currentLevel = gameState.levelList[gameState.currentLevelIndex];
            if (!currentLevel) return; // Game might have ended
            const char = Math.random() < 0.4 ? currentLevel.target : currentLevel.distractors[Math.floor(Math.random() * currentLevel.distractors.length)];
            
            // éš¨æ©Ÿé¸æ“‡å‹•ç‰©
            const animalKeys = Object.keys(animalSVGs);
            const randomAnimal = animalKeys[Math.floor(Math.random() * animalKeys.length)];
            animalSVGEl.innerHTML = animalSVGs[randomAnimal];
            
            characterEl.textContent = char;
            animalContainer.dataset.char = char;
            animalContainer.classList.add('up');
            animalContainer.classList.remove('whacked');
            
            setTimeout(() => {
                if(animalContainer) animalContainer.classList.remove('up');
            }, gameState.peepDuration);
        }

        function showLevelEndScreen(isTimeUp) {
            clearInterval(animalIntervalId);
            animalIntervalId = null;
            if (isTimeUp) {
                levelEndTitle.textContent = "æ™‚é–“åˆ°ï¼";
                nextLevelBtn.classList.add('hidden');
            } else {
                levelEndTitle.textContent = `ç¬¬ ${Math.floor(gameState.currentLevelIndex / 2) + 1} é—œå®Œæˆï¼`;
                nextLevelBtn.classList.remove('hidden');
                // æ’­æ”¾ç²å‹éŸ³æ•ˆ
                winnerSound.currentTime = 0; // é‡ç½®åˆ°é–‹é ­
                winnerSound.play().catch(e => console.warn("æ’­æ”¾ç²å‹éŸ³æ•ˆå¤±æ•—:", e));
            }
            levelEndScore.textContent = `ç›®å‰åˆ†æ•¸ï¼š${gameState.score}`;
            reviewMistakesBtn.disabled = gameState.mistakesThisLevel.length === 0;
            levelEndScreen.classList.remove('hidden');
        }

        function proceedToNextLevel() {
            levelEndScreen.classList.add('hidden');
            gameState.currentLevelIndex++;
            gameState.slowSkillTokens++;
            setupLevel();
        }

        function endGame(isQuit) {
            clearInterval(timerId);
            timerId = null;
            clearInterval(animalIntervalId);
            animalIntervalId = null;

            gameScreen.classList.add('hidden');
            
            // Save skills before exiting
            if (currentUser && gameData.users[currentUser]) {
                gameData.users[currentUser].skillTokens = gameState.slowSkillTokens;
            }

            if (!isQuit) {
                if (currentUser && gameData.users[currentUser]) {
                    gameData.users[currentUser].savedTimedGame = null; // Clear saved game on normal finish
                }
                gameOverScreen.classList.remove('hidden');
                finalScoreEl.textContent = gameState.score;
                updateHighScore(gameState.score);
                displayStars(gameState.score);
                // åœ¨ç·´ç¿’æ¨¡å¼å®Œæˆæ‰€æœ‰é—œå¡æ™‚æ’­æ”¾ç²å‹éŸ³æ•ˆ
                if (gameState.mode === 'practice') {
                    winnerSound.currentTime = 0; // é‡ç½®åˆ°é–‹é ­
                    winnerSound.play().catch(e => console.warn("æ’­æ”¾ç²å‹éŸ³æ•ˆå¤±æ•—:", e));
                }
                if (gameState.mode === 'timed') {
                    getAIFeedback();
                } else {
                    aiFeedbackText.parentElement.classList.add('hidden');
                }
            }
            
            saveGameData();

            if(isQuit) {
                showMainMenu();
            }
        }
        
        // --- UI æ›´æ–°èˆ‡è¼”åŠ©å‡½å¼ ---

        function updateUI() {
            scoreEl.textContent = gameState.score;
            scoreEl.classList.add('score-pop');
            scoreEl.addEventListener('animationend', () => scoreEl.classList.remove('score-pop'), { once: true });

            comboEl.textContent = gameState.combo;
            skillSlowTokensEl.textContent = gameState.slowSkillTokens;
            skillSlowBtn.disabled = gameState.slowSkillTokens <= 0;
            
            if (gameState.mode === 'practice') {
                hitsEl.textContent = `${gameState.correctHitsThisLevel} / 3`;
                const totalWeeks = Math.ceil(gradeFourLevels.length / 2);
                const currentWeek = Math.floor(gameState.currentLevelIndex / 2) + 1;
                gameModeTitleEl.textContent = `é—–é—œç·´ç¿’ (å››å¹´ç´š - ç¬¬ ${currentWeek} / ${totalWeeks} é—œ)`;
            } else {
                timerEl.textContent = gameState.timeLeft;
            }
            const currentLevel = gameState.levelList[gameState.currentLevelIndex];
            if(currentLevel) targetCharEl.textContent = currentLevel.target;
        }

        function activateSlowSkill() {
            if (gameState.slowSkillTokens > 0) {
                gameState.slowSkillTokens--;
                updateUI(); 

                const originalSpeed = gameState.gameSpeed;
                const originalPeepDuration = gameState.peepDuration;

                const slowSpeed = originalSpeed + 500;
                const slowPeepDuration = originalPeepDuration + 700;

                clearInterval(animalIntervalId);
                animalIntervalId = setInterval(peep, slowSpeed);
                
                const originalPeep = window.peep; // Store global peep
                
                const slowPeep = function() {
                     if (!holes || holes.length === 0) return;
                    const hole = holes[Math.floor(Math.random() * holes.length)];
                    const animalContainer = hole.querySelector('.animal-container');
                    const characterEl = animalContainer.querySelector('.character');
                    const animalSVGEl = animalContainer.querySelector('.animal-svg-wrapper');
                    
                    const currentLevel = gameState.levelList[gameState.currentLevelIndex];
                    if (!currentLevel) return; // Game might have ended
                    const char = Math.random() < 0.4 ? currentLevel.target : currentLevel.distractors[Math.floor(Math.random() * currentLevel.distractors.length)];
                    
                    const animalKeys = Object.keys(animalSVGs);
                    const randomAnimal = animalKeys[Math.floor(Math.random() * animalKeys.length)];
                    animalSVGEl.innerHTML = animalSVGs[randomAnimal];
                    
                    characterEl.textContent = char;
                    animalContainer.dataset.char = char;
                    animalContainer.classList.add('up');
                    animalContainer.classList.remove('whacked');
                    
                    setTimeout(() => {
                        if(animalContainer) animalContainer.classList.remove('up');
                    }, slowPeepDuration);
                };

                // Override peep for 5 seconds
                const intervalId = setInterval(slowPeep, slowSpeed);
                clearInterval(animalIntervalId);
                animalIntervalId = intervalId;


                setTimeout(() => {
                    if (animalIntervalId) { // Check if game is still running
                        clearInterval(animalIntervalId);
                        animalIntervalId = setInterval(peep, originalSpeed);
                    }
                }, 5000); 
            }
        }

        function showHammerAnimation(element) {
            const hammer = document.createElement('div');
            hammer.classList.add('hammer');
            hammer.innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="rotate(45 50 50)"><rect x="40" y="0" width="20" height="60" rx="5" fill="#A1887F"/><rect x="25" y="55" width="50" height="30" rx="8" fill="#795548"/></g></svg>`;
            element.parentElement.appendChild(hammer);
            hammer.addEventListener('animationend', () => hammer.remove());
        }

        function showScorePopup(text, element, colorClass) {
            const popup = document.createElement('div');
            popup.textContent = text;
            popup.className = `score-popup ${colorClass}`;
            element.parentElement.appendChild(popup);
            popup.addEventListener('animationend', () => popup.remove());
        }
        
        function displayStars(finalScore) {
            starsEl.innerHTML = '';
            let starCount = 0;
            if (finalScore >= 300) starCount = 3;
            else if (finalScore >= 150) starCount = 2;
            else if (finalScore > 0) starCount = 1;
            for (let i = 0; i < 3; i++) {
                const star = document.createElement('span');
                star.textContent = i < starCount ? 'â˜…' : 'â˜†';
                star.className = i < starCount ? 'text-yellow-400' : 'text-gray-300';
                starsEl.appendChild(star);
            }
        }
        
        // --- å­¸ç”Ÿç”¨æˆ¶èˆ‡æ•¸æ“šç®¡ç† ---
        
        function loadGameData() {
            gameData = JSON.parse(localStorage.getItem('whackACharGameData') || '{"users":{}}');
        }
        
        function saveGameData() {
            localStorage.setItem('whackACharGameData', JSON.stringify(gameData));
        }

        function loadUserProfiles() {
            userSelect.innerHTML = '';
            if (!gameData.users || Object.keys(gameData.users).length === 0) {
                userSelect.innerHTML = '<option>è«‹æ–°å¢å­¸ç”Ÿ</option>';
                confirmUserBtn.disabled = true;
                return;
            }
            Object.keys(gameData.users).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                userSelect.appendChild(option);
            });
            confirmUserBtn.disabled = false;
        }

        function addUser() {
            const name = newUserInput.value.trim();
            if (name && !gameData.users[name]) {
                gameData.users[name] = {
                    highScore: 0,
                    customLibrary: {},
                    skillTokens: 0,
                    savedTimedGame: null
                };
                saveGameData();
                loadUserProfiles();
                userSelect.value = name;
                newUserInput.value = '';
            }
        }

        function confirmUser() {
            currentUser = userSelect.value;
            if (currentUser && gameData.users[currentUser]) {
                showMainMenu();
            }
        }

        function showMainMenu() {
            userSelectionView.classList.add('hidden');
            mainMenuView.classList.remove('hidden');
            startScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            currentUserEl.textContent = currentUser;
            updateHighScoreDisplay();

            // Check for a saved timed game
            if (gameData.users[currentUser]?.savedTimedGame) {
                timedModeBtn.textContent = 'ç¹¼çºŒè¨ˆæ™‚æ¯”è³½';
                timedModeBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                timedModeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                timedModeBtn.textContent = 'è¨ˆæ™‚æ¯”è³½';
                timedModeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                timedModeBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            }
        }

        function updateHighScore(currentScore) {
            if (currentScore > gameData.users[currentUser].highScore) {
                gameData.users[currentUser].highScore = currentScore;
                saveGameData();
                newHighScoreMsgEl.classList.remove('hidden');
            } else {
                newHighScoreMsgEl.classList.add('hidden');
            }
            updateHighScoreDisplay();
        }

        function updateHighScoreDisplay() {
             const userHighScore = gameData.users[currentUser]?.highScore || 0;
             highScoreStartEl.textContent = userHighScore;
             highScoreEndEl.textContent = userHighScore;
        }
        
        // --- AI è­˜åˆ¥èˆ‡é¡Œåº« ---
        
        async function callGeminiAPI(payload) {
             const apiKey = ""; // API Key is handled by the environment
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    console.error("API Error Response:", await response.text());
                    throw new Error(`AI API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (!candidate) {
                    // This can happen if the prompt is blocked entirely.
                    throw new Error('AI æœªèƒ½ç”Ÿæˆå›æ‡‰ã€‚è«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥å…§å®¹ã€‚');
                }
                // If finishReason is SAFETY or other, there might not be any content.
                if (candidate.finishReason !== 'STOP' && candidate.finishReason !== 'MAX_TOKENS') {
                     console.warn(`AI å›  ${candidate.finishReason} è€Œåœæ­¢ã€‚`);
                     // Return empty content instead of throwing an error for cases like safety blocks
                     return payload.generationConfig?.responseMimeType === 'application/json' ? '[]' : '';
                }
                const content = candidate.content?.parts?.[0]?.text;
                // If content is undefined, it's a valid empty response.
                if (typeof content === 'undefined') {
                    return payload.generationConfig?.responseMimeType === 'application/json' ? '[]' : '';
                }
                return content;
             } catch(error) {
                console.error("å‘¼å« Gemini API å¤±æ•—:", error);
                throw error;
             }
        }
        
        async function getCharDefinitions(chars) {
            const uniqueChars = [...new Set(chars)];
            const payload = {
                contents: [{ parts: [{ text: `è«‹ç‚ºä»¥ä¸‹æ¯å€‹ç¹é«”ä¸­æ–‡å­—æä¾›ä¸€å€‹ç°¡çŸ­çš„æ ¸å¿ƒå®šç¾©ï¼ˆ15å­—ä»¥å…§ï¼‰ã€‚ä»¥ JSON ç‰©ä»¶æ ¼å¼è¿”å›ï¼Œkey ç‚ºæ¼¢å­—ï¼Œvalue ç‚ºå®šç¾©ã€‚æ¼¢å­—åˆ—è¡¨ï¼š${uniqueChars.join('ã€')}` }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            try {
                const jsonText = await callGeminiAPI(payload);
                return JSON.parse(jsonText);
            } catch (error) {
                return uniqueChars.reduce((obj, char) => {
                    obj[char] = "æŸ¥è©¢å¤±æ•—";
                    return obj;
                }, {});
            }
        }
        
        async function getAIFeedback() {
            aiFeedbackText.parentElement.classList.remove('hidden');
            aiFeedbackText.textContent = 'AI å¤¥ä¼´æ­£åœ¨ç‚ºæ‚¨æº–å‚™é¼“å‹µçš„è©±...';
            try {
                const mistakeString = allMistakesInGame.length > 0
                    ? `ä»–åœ¨é€™äº›å­—ä¸ŠçŠ¯äº†éŒ¯ï¼š${[...new Set(allMistakesInGame.map(m => `ã€Œ${m.target}ã€éŒ¯æ‰“æˆã€Œ${m.wrong}ã€`))].join('ã€')}ã€‚`
                    : "ä»–æ²’æœ‰çŠ¯ä»»ä½•éŒ¯èª¤ã€‚";

                const prompt = `ä½ æ˜¯ä¸€å€‹è¦ªåˆ‡çš„éŠæˆ²å‹•ç‰©å¤¥ä¼´ã€‚ä¸€å€‹å­¸ç”Ÿå‰›å‰›å®Œæˆäº†ã€Œå­—è©åœ°é¼ æˆ°ã€éŠæˆ²ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡çµ¦ä»–ä¸€æ®µç°¡çŸ­ï¼ˆç´„ 50 å­—ï¼‰ã€æœ‰è¶£ä¸”å……æ»¿é¼“å‹µçš„è©±ã€‚ä»–çš„æœ€çµ‚åˆ†æ•¸æ˜¯ï¼š${gameState.score} åˆ†ã€‚${mistakeString}è«‹æ ¹æ“šé€™äº›è³‡è¨Šçµ¦äºˆå€‹äººåŒ–çš„å›é¥‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»–éŒ¯äº†å¾ˆå¤šå­—ï¼Œå¯ä»¥é¼“å‹µä»–å†æ¥å†å²ï¼›å¦‚æœåˆ†æ•¸å¾ˆé«˜ï¼Œå¯ä»¥å¤§åŠ›ç¨±è®šã€‚é–‹é ­å¯ä»¥ç”¨ä¸€äº›å¯æ„›çš„èªæ°£è©ï¼Œä¾‹å¦‚ã€Œå“‡å–”ï¼ã€æˆ–ã€Œå˜¿ï¼ä½ çœŸæ£’ï¼ã€ã€‚`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const feedback = await callGeminiAPI(payload);
                aiFeedbackText.textContent = feedback;
            } catch (error) {
                aiFeedbackText.textContent = 'å“‡ï¼ä½ çœŸæ˜¯å¤ªæ£’äº†ï¼Œç¹¼çºŒåŠªåŠ›å–”ï¼';
            }
        }

        function getLevelsFromText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            return lines.map(line => {
                const parts = line.split(/[:ï¼š]/);
                if(parts.length !== 2) return null;
                const target = parts[0].trim();
                const distractors = parts[1].trim().split(/[,ï¼Œ\s]+/).filter(Boolean);
                if(target.length !== 1 || distractors.length === 0) return null;
                return { target, distractors };
            }).filter(Boolean);
        }

        function loadCustomLibrary() {
            const library = gameData.users[currentUser]?.customLibrary || {};
            customLibraryList.innerHTML = '';
            const keys = Object.keys(library);
            if(keys.length === 0) {
                customLibraryList.innerHTML = '<p class="text-slate-400">å°šç„¡è‡ªå®šç¾©é¡Œç›®</p>';
                playLibraryBtn.disabled = true;
                return;
            }
            keys.forEach(key => {
                const level = library[key];
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center');
                div.innerHTML = `<input type="checkbox" id="lib-${level.target}" data-level='${JSON.stringify(level)}' class="mr-2"><label for="lib-${level.target}">${level.target}: ${level.distractors.join(',')}</label>`;
                customLibraryList.appendChild(div);
            });
            playLibraryBtn.disabled = false;
        }

        function saveLevelsToLibrary(levels) {
            if (!currentUser || !gameData.users[currentUser]) {
                console.error("éŒ¯èª¤ï¼šæ²’æœ‰é¸æ“‡ç›®å‰ä½¿ç”¨è€…ï¼Œç„¡æ³•å„²å­˜é¡Œåº«ã€‚");
                return false;
            }
            if (!gameData.users[currentUser].customLibrary) {
                 gameData.users[currentUser].customLibrary = {};
            }
            levels.forEach(level => {
                if (!gameData.users[currentUser].customLibrary[level.target]) {
                    gameData.users[currentUser].customLibrary[level.target] = level;
                }
            });
            saveGameData();
            return true;
        }
        
        function populateLevelSelectionGrid() {
            levelGrid.innerHTML = '';
            const weeklyTargets = gradeFourLevels.filter((_, index) => index % 2 === 0);
            weeklyTargets.forEach((level, index) => {
                const button = document.createElement('button');
                button.classList.add('p-2', 'border', 'rounded-lg', 'hover:bg-blue-100', 'transition');
                button.innerHTML = `<p class="font-bold">ç¬¬ ${index + 1} é—œ</p><p class="text-sm text-slate-500">${level.target}, ${level.distractors[0]}...</p>`;
                button.dataset.startIndex = index * 2;
                button.addEventListener('click', (e) => {
                    const startIndex = parseInt(e.currentTarget.dataset.startIndex);
                    levelSelectionScreen.classList.add('hidden');
                    startGame('practice', gradeFourLevels, startIndex);
                });
                levelGrid.appendChild(button);
            });
        }

        function resumeGame(savedGameState) {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            allMistakesInGame = []; // For simplicity, don't resume mistakes list

            gameState = savedGameState;

            // Re-setup UI and intervals
            if (gameState.mode === 'timed') {
                timerDisplay.classList.remove('hidden');
                hitsDisplay.classList.add('hidden');
                comboDisplay.classList.remove('hidden');
                gameModeTitleEl.textContent = 'è¨ˆæ™‚æ¯”è³½ (å››å¹´ç´š)';
                saveQuitBtn.textContent = 'å„²å­˜ä¸¦é›¢é–‹';
                timerId = setInterval(updateTimer, 1000);
            } else {
                // This path is not expected for saved games in the current logic
                timerDisplay.classList.add('hidden');
                hitsDisplay.classList.remove('hidden');
                comboDisplay.classList.add('hidden');
                saveQuitBtn.textContent = 'é›¢é–‹éŠæˆ²';
            }

            updateUI();
            animalIntervalId = setInterval(peep, gameState.gameSpeed);
        }

        function handleImport(file) {
            if (!file) return;
            customErrorMsg.textContent = '';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const newLevels = jsonData.map(row => {
                        if (!row || row.length === 0 || !row[0]) return null;
                        return {
                            target: String(row[0]).trim(),
                            distractors: row.slice(1).map(d => String(d).trim()).filter(Boolean)
                        };
                    }).filter(level => level && level.target.length === 1 && level.distractors.length > 0);

                    if (newLevels.length > 0) {
                        if (saveLevelsToLibrary(newLevels)) {
                            loadCustomLibrary();
                            alert(`æˆåŠŸå°å…¥ ${newLevels.length} é¡Œï¼`);
                        } else {
                            alert('å°å…¥å¤±æ•—ï¼Œè«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿï¼');
                        }
                    } else {
                        alert('Excel æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆæ ¼å¼çš„é¡Œç›®ã€‚');
                    }
                } catch (error) {
                    console.error("å°å…¥ Excel å¤±æ•—:", error);
                    alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                }
            };
            reader.readAsArrayBuffer(file);
            excelUploadInput.value = ''; // Reset file input
        }

        function handleExport() {
            if (!currentUser || !gameData.users[currentUser]) {
                alert("è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿï¼");
                return;
            }
            const library = gameData.users[currentUser].customLibrary;
            if (Object.keys(library).length === 0) {
                alert("è‡ªå®šç¾©é¡Œåº«æ˜¯ç©ºçš„ï¼");
                return;
            }

            const dataForSheet = [['ç›®æ¨™å­—', 'å¹²æ“¾å­—1', 'å¹²æ“¾å­—2', 'å¹²æ“¾å­—3']];
            Object.values(library).forEach(level => {
                dataForSheet.push([level.target, ...level.distractors]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(dataForSheet);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "é¡Œåº«");
            XLSX.writeFile(workbook, `${currentUser}_é¡Œåº«.xlsx`);
        }
        
        // --- äº‹ä»¶ç›£è½å™¨ ---

        // ä¸»æµç¨‹æŒ‰éˆ•
        addUserBtn.addEventListener('click', addUser);
        confirmUserBtn.addEventListener('click', confirmUser);
        practiceModeBtn.addEventListener('click', () => {
            levelSelectionScreen.classList.remove('hidden');
        });
        timedModeBtn.addEventListener('click', () => {
            const savedGame = gameData.users[currentUser]?.savedTimedGame;
            if (savedGame) {
                // Clear saved game once loaded
                gameData.users[currentUser].savedTimedGame = null;
                saveGameData();
                // Restore game from saved state
                resumeGame(savedGame);
            } else {
                startGame('timed', gradeFourLevels);
            }
        });
        saveQuitBtn.addEventListener('click', () => {
             // Stop all game loops
            clearInterval(timerId);
            timerId = null;
            clearInterval(animalIntervalId);
            animalIntervalId = null;
            gameScreen.classList.add('hidden');

            // Save data
            if (currentUser && gameData.users[currentUser]) {
                gameData.users[currentUser].skillTokens = gameState.slowSkillTokens;
                if (gameState.mode === 'timed') {
                    gameData.users[currentUser].savedTimedGame = gameState;
                }
                saveGameData();
            }
            
            // Go to main menu
            showMainMenu();
        });
        restartBtn.addEventListener('click', showMainMenu);

        // é—œå¡çµæŸæµç¨‹
        nextLevelBtn.addEventListener('click', proceedToNextLevel);
        endGameBtn.addEventListener('click', () => {
            levelEndScreen.classList.add('hidden');
            endGame(false);
        });
        reviewMistakesBtn.addEventListener('click', async () => {
            mistakesListEl.innerHTML = '<div class="loader mx-auto"></div>';
            reviewScreen.classList.remove('hidden');

            const charsToDefine = new Set();
            gameState.mistakesThisLevel.forEach(m => {
                charsToDefine.add(m.target);
                charsToDefine.add(m.wrong);
            });
            
            const definitions = await getCharDefinitions(Array.from(charsToDefine));

            mistakesListEl.innerHTML = '';
            if (gameState.mistakesThisLevel.length > 0) {
                 gameState.mistakesThisLevel.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `<p class="font-bold">ç›®æ¨™ã€Œ${m.target}ã€ï¼ŒéŒ¯æ‰“æˆã€Œ${m.wrong}ã€</p>
                                     <p class="text-sm text-slate-600 pl-4">${m.target}: ${definitions[m.target] || '...'}</p>
                                     <p class="text-sm text-slate-600 pl-4">${m.wrong}: ${definitions[m.wrong] || '...'}</p>`;
                    mistakesListEl.appendChild(div);
                 });
            } else {
                 mistakesListEl.innerHTML = '<p>æ²’æœ‰éŒ¯èª¤ï¼</p>';
            }
        });
        closeReviewBtn.addEventListener('click', () => reviewScreen.classList.add('hidden'));

        // é—œå¡é¸æ“‡
        closeLevelSelectionBtn.addEventListener('click', () => levelSelectionScreen.classList.add('hidden'));

        // è¨­å®šé é¢
        settingsBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert("è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿï¼");
                return;
            }
            loadCustomLibrary();
            settingsScreen.classList.remove('hidden');
        });
        closeSettingsBtn.addEventListener('click', () => {
            settingsScreen.classList.add('hidden');
            customErrorMsg.textContent = '';
        });
        
        
        addCustomBtn.addEventListener('click', () => {
            const text = customLevelsInput.value.trim();
            if (!text) return;
            const newLevels = getLevelsFromText(text);
            if (newLevels && newLevels.length > 0) {
                if (saveLevelsToLibrary(newLevels)) {
                    loadCustomLibrary();
                    customLevelsInput.value = '';
                    customErrorMsg.textContent = 'æˆåŠŸæ–°å¢ï¼';
                    setTimeout(() => customErrorMsg.textContent = '', 2000);
                } else {
                    customErrorMsg.textContent = 'è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿï¼';
                    setTimeout(() => customErrorMsg.textContent = '', 2000);
                }
            }
        });
        playLibraryBtn.addEventListener('click', () => {
            const selectedLevels = [];
            customLibraryList.querySelectorAll('input:checked').forEach(cb => {
                selectedLevels.push(JSON.parse(cb.dataset.level));
            });
            if (selectedLevels.length > 0) {
                settingsScreen.classList.add('hidden');
                // å¾é¡Œåº«é–‹å§‹é è¨­ç‚ºç·´ç¿’æ¨¡å¼
                startGame('practice', selectedLevels);
            } else {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œç›®');
            }
        });
        
        importExcelBtn.addEventListener('click', () => excelUploadInput.click());
        excelUploadInput.addEventListener('change', (e) => handleImport(e.target.files[0]));
        exportExcelBtn.addEventListener('click', handleExport);
        
        skillSlowBtn.addEventListener('click', activateSlowSkill);

        // --- åˆå§‹åŒ– ---
        function init() {
             // è¨­å®š PDF.js worker çš„è·¯å¾‘ï¼Œç¢ºä¿åœ¨ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ
            if (typeof window.pdfjsLib !== 'undefined') {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
            }
            createBoard();
            holes = Array.from(document.querySelectorAll('.hole'));
            loadGameData();
            loadUserProfiles();
            populateLevelSelectionGrid();
        }

        init();
    };
})();
</script>
</body>
</html>

